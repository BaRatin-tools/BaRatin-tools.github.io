<!DOCTYPE html>
<html lang="fr">

  <head>
    
	    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)'], ['$', '$']]                  
    }
  };
</script>



    

    <meta charset="utf-8">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Utilisation de RBaM</title>
<meta name="author" content="" />





<meta name="description" content="">

<meta name="generator" content="Hugo 0.122.0">


<link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel='stylesheet' type='text/css'>


<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.11.2/css/all.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link href="/css/animate.css" rel="stylesheet">



  <link href="/css/style.blue.css" rel="stylesheet" id="theme-stylesheet">



<link href="/css/custom.css?1713520952" rel="stylesheet">



  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->



<link rel="shortcut icon" href="/img/logo.png" type="image/x-icon" />
<link rel="apple-touch-icon" href="/img/logo.png" />


<link rel="alternate" href="https://baratin-tools.github.io/index.xml" type="application/rss+xml" title="BaRatin - Bayesian Rating Curves">








<meta property="og:locale" content="fr">
<meta property="og:site_name" content="BaRatin - Bayesian Rating Curves">
<meta property="og:title" content="Utilisation de RBaM">
<meta property="og:type" content="website">
<meta property="og:url" content="https://baratin-tools.github.io/fr/doc/case/rbam/" />
<meta property="og:description" content="">
<meta property="og:image" content="https://baratin-tools.github.io/img/logo.png">
<meta property="og:image:type" content="image/png">



  <meta property="og:image:width" content="145">
  <meta property="og:image:height" content="145">






<meta name="twitter:card" content="summary">

<meta name="twitter:title" content="Utilisation de RBaM">

<meta name="twitter:image" content="https://baratin-tools.github.io/img/logo.png">

<meta name="twitter:description" content="">


  </head>

  <body>

    <div id="all">

        


        <header class="navbar-affixed-top" data-spy="affix" data-offset-top="62">
    <div class="navbar navbar-default yamm " role="navigation" id="navbar">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand home" href="/fr/">
                    
                      <img src="/img/logoWithText.png" alt="Utilisation de RBaM logo" class="hidden-xs hidden-sm" />
                      <img src="/img/logo.png" alt="Utilisation de RBaM logo" class="visible-xs visible-sm" />
                    
                    <span class="sr-only">Utilisation de RBaM - aller √† l&#39;accueil</span>
                </a>
                <div class="navbar-buttons">
                    <button type="button" class="navbar-toggle btn-template-main" data-toggle="collapse" data-target="#navigation">
                      <span class="sr-only">Basculer la Navigation</span>
                        <i class="fas fa-align-justify"></i>
                    </button>
                </div>
            </div>
            

            <div class="navbar-collapse collapse" id="navigation">
                <ul class="nav navbar-nav navbar-right">
                  

                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    <a href="/fr">Accueil</a>
                  </li>
                  
                  
                  
                  

                  

                  

                  

                  
                    
                    
                    <li class="dropdown ">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Documentation <span class="caret"></span></a>
                        
                        <ul class="dropdown-menu">
                            
                            <li><a href="/fr/doc/baratinage">BaRatinAGE v3</a></li>
                            
                            <li><a href="/fr/doc/topics">Fiches Th√©matiques</a></li>
                            
                            <li><a href="/fr/doc/case">Cas d&#39;√©tude</a></li>
                            
                        </ul>
                        
                    </li>
                  
                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    <a href="/fr/ressources">Ressources</a>
                  </li>
                  
                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    <a href="/fr/blog/">Blog</a>
                  </li>
                  
                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    <a href="/fr/a-propos">A propos</a>
                  </li>
                  
                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    <a href="/fr/index.xml">rss</a>
                  </li>
                  
                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    <a href="/en">üá¨üáß en</a>
                  </li>
                  
                  
                </ul>
            </div>
            

            <div class="collapse clearfix" id="search">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <span class="input-group-btn">
                    <button type="submit" class="btn btn-template-main"><i class="fas fa-search"></i></button>
                </span>
                    </div>
                </form>
            </div>
            
        </div>
    </div>
</header>




        <div id="heading-breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>Utilisation de RBaM</h1>
            </div>
        </div>
    </div>
</div>


        <div id="content">
            <div class="container">

                <div class="row">

                    

                    <div class="col-md-10" id="blog-post">

                        <div id="post-content">
                          

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction"><span class="toc-section-number">1</span> Introduction</a></li>
<li><a href="#estimation-dune-courbe-de-tarage-baratin" id="toc-estimation-dune-courbe-de-tarage-baratin"><span class="toc-section-number">2</span> Estimation d‚Äôune courbe de tarage BaRatin</a>
<ul>
<li><a href="#d√©finition-des-donn√©es-de-jaugeage" id="toc-d√©finition-des-donn√©es-de-jaugeage"><span class="toc-section-number">2.1</span> D√©finition des donn√©es de jaugeage</a></li>
<li><a href="#d√©finition-du-mod√®le-de-courbe-de-tarage" id="toc-d√©finition-du-mod√®le-de-courbe-de-tarage"><span class="toc-section-number">2.2</span> D√©finition du mod√®le de courbe de tarage</a></li>
<li><a href="#lancer-bam-et-explorer-les-simulations-mcmc" id="toc-lancer-bam-et-explorer-les-simulations-mcmc"><span class="toc-section-number">2.3</span> Lancer BaM et explorer les simulations MCMC</a></li>
<li><a href="#estimer-la-courbe-de-tarage-et-ses-incertitudes" id="toc-estimer-la-courbe-de-tarage-et-ses-incertitudes"><span class="toc-section-number">2.4</span> Estimer la courbe de tarage et ses incertitudes</a></li>
<li><a href="#production-dun-hydrogramme-incertain" id="toc-production-dun-hydrogramme-incertain"><span class="toc-section-number">2.5</span> Production d‚Äôun hydrogramme incertain</a></li>
</ul></li>
<li><a href="#conclusion" id="toc-conclusion"><span class="toc-section-number">3</span> Conclusion</a></li>
</ul>
</div>

<div id="introduction" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Introduction</h1>
<p>BaM (Bayesian Modeling) est un outil permettant d‚Äôestimer un mod√®le par inf√©rence Bay√©sienne - n‚Äôimporte quel mod√®le en principe, mais ici nous nous int√©resserons au <a href="/fr/doc/topics/courbe-de-tarage">mod√®le de courbe de tarage</a> de BaRatin. Le package <a href="https://github.com/BaM-tools/RBaM">RBaM</a> est une interface <code>R</code> au <a href="https://github.com/BaM-tools/BaM">code de calcul de BaM</a>. Il permet de d√©finir les objets qui constituent les briques de base d‚Äôun cas d‚Äô√©tude op√©r√© avec BaM, et fournit les outils d‚Äôanalyse associ√©s. Son utilisation typique peut √™tre r√©sum√©e comme suit:</p>
<ol style="list-style-type: decimal">
<li>Rassembler les donn√©es qui serviront √† caler le mod√®le.</li>
<li>D√©finir le mod√®le et sp√©cifier des distributions a priori pour ses param√®tres.</li>
<li>Effectuer un inf√©rence Bay√©sienne par simulation MCMC.</li>
<li>Effectuer les pr√©dictions d√©sir√©es.</li>
</ol>
<p><code>RBaM</code> doit √™tre install√© une fois lors de la premi√®re utilisation, puis charg√© avant chaque utilisation.</p>
<pre class="r"><code># devtools::install_github(&#39;BaM-tools/RBaM&#39;) # Premi√®re utilisation : installer le package depuis GitHub
library(RBaM) # Charger le package</code></pre>
<p>Le catalogue des distributions a priori disponibles peut √™tre affich√© comme indiqu√© ci-dessous. La commande montre aussi le catalogue des mod√®les disponibles, mais ici nous aborderons uniquement le mod√®le BaRatin.</p>
<pre class="r"><code>getCatalogue()</code></pre>
<pre><code>## $distributions
##  [1] &quot;Gaussian&quot;     &quot;Uniform&quot;      &quot;Triangle&quot;     &quot;LogNormal&quot;    &quot;LogNormal3&quot;  
##  [6] &quot;Exponential&quot;  &quot;GPD&quot;          &quot;Gumbel&quot;       &quot;GEV&quot;          &quot;GEV_min&quot;     
## [11] &quot;Inverse_Chi2&quot; &quot;PearsonIII&quot;   &quot;Geometric&quot;    &quot;Poisson&quot;      &quot;Bernoulli&quot;   
## [16] &quot;Binomial&quot;     &quot;NegBinomial&quot;  &quot;FlatPrior&quot;    &quot;FlatPrior+&quot;   &quot;FlatPrior-&quot;  
## [21] &quot;FIX&quot;          &quot;VAR&quot;         
## 
## $models
##  [1] &quot;TextFile&quot;                 &quot;BaRatin&quot;                 
##  [3] &quot;BaRatinBAC&quot;               &quot;SFD&quot;                     
##  [5] &quot;SGD&quot;                      &quot;SWOT&quot;                    
##  [7] &quot;Vegetation&quot;               &quot;AlgaeBiomass&quot;            
##  [9] &quot;DynamicVegetation&quot;        &quot;Recession_h&quot;             
## [11] &quot;Segmentation&quot;             &quot;Sediment&quot;                
## [13] &quot;SuspendedLoad&quot;            &quot;Linear&quot;                  
## [15] &quot;Mixture&quot;                  &quot;Orthorectification&quot;      
## [17] &quot;GR4J&quot;                     &quot;Tidal&quot;                   
## [19] &quot;SFDTidal&quot;                 &quot;SFDTidal2&quot;               
## [21] &quot;SFDTidalJones&quot;            &quot;SFDTidal4&quot;               
## [23] &quot;SFDTidal_Qmec&quot;            &quot;TidalODE&quot;                
## [25] &quot;TidalRemenieras&quot;          &quot;SFDTidal_Sw_correction&quot;  
## [27] &quot;MAGE&quot;                     &quot;HydraulicControl_section&quot;</code></pre>
</div>
<div id="estimation-dune-courbe-de-tarage-baratin" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Estimation d‚Äôune courbe de tarage BaRatin</h1>
<p>La premi√®re chose √† faire est de d√©finir un dossier faisant office d‚Äôespace de travail (workspace), dans lequel seront sauvegard√©s tous les resultats.</p>
<pre class="r"><code>workspace=file.path(getwd(),&#39;BaM_workspace&#39;)</code></pre>
<p>L‚Äôexemple utilis√© ci-dessous est la courbe de tarage de l‚Äô<a href="https://fr.wikipedia.org/wiki/Ard%C3%A8che_(rivi%C3%A8re)">Ard√®che</a> √† la station de <a href="https://www.hydro.eaufrance.fr/stationhydro/V506401001/fiche">Sauze-Saint-Martin</a>.</p>
<div id="d√©finition-des-donn√©es-de-jaugeage" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> D√©finition des donn√©es de jaugeage</h2>
<p>Les donn√©es de jaugeage utilis√©es pour estimer cette courbe de tarage sont incluses dans le package <code>RBaM</code> sous la forme d‚Äôun dataframe nomm√© <code>SauzeGaugings</code> qui contient trois colonnes : la hauteur <code>H</code>, le d√©bit <code>Q</code> et l‚Äôincertitude-type du d√©bit <code>uQ</code>. <strong>ATTENTION</strong>: l‚Äôincertitude est exprim√©e comme un <em>√©cart-type</em> et non sous la forme d‚Äôune <em>incertitude √©tendue</em> comme dans <code>BaRatinAGE</code>. Cette derni√®re est √©gale √† 1.96 fois l‚Äô√©cart-type, et correspond √† la demie-longueur d‚Äôun intervalle d‚Äôincertitude √† 95% sous hypoth√®se Gaussienne.</p>
<pre class="r"><code># Trac√© des donn√©es du data frame SauzeGaugings
# Notez le facteur 1.96 pour passer de l&#39;incertitude-type √† un intervalle √† 95%
plot(x=SauzeGaugings$H,y=SauzeGaugings$Q)
segments(x0=SauzeGaugings$H,y0=SauzeGaugings$Q-1.96*SauzeGaugings$uQ,y1=SauzeGaugings$Q+1.96*SauzeGaugings$uQ)</code></pre>
<p><img src="en/fig-unnamed-chunk-4-1.png" width="672" /></p>
<p>Le code ci-dessous est utilis√© pour d√©finir les variables d‚Äôentr√©e/sortie du mod√®le. Le mod√®le utilis√© ici √©tant une courbe de tarage, la hauteur est la variable d‚Äôentr√©e et le d√©bit la variable de sortie. L‚Äôincertitude-type sur le d√©bit jaug√© est √©galement indiqu√©e, et en cas d‚Äôomission elle sera consid√©r√©e comme nulle. Notez qu‚Äôencore une fois c‚Äôest l‚Äôincertitude-type qui est attendue par <code>RBaM</code>, et non l‚Äôincertitude √©tendue comme dans <code>BaRatinAGE</code>.</p>
<pre class="r"><code># D√©finition du jeu de donn√©es de calage:  
# variable d‚Äôentr√©e (X), de sortie (Y) et incertitude-type sur la variable de sortie (Yu).
# Une copie de ce jeu de donn√©es sera √©crite dans le dossier d√©fini dans data.dir.
D=dataset(X=SauzeGaugings[&#39;H&#39;],Y=SauzeGaugings[&#39;Q&#39;],Yu=SauzeGaugings[&#39;uQ&#39;],data.dir=workspace)</code></pre>
</div>
<div id="d√©finition-du-mod√®le-de-courbe-de-tarage" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> D√©finition du mod√®le de courbe de tarage</h2>
<p>La station de Sauze-Saint-Martin est caract√©ris√©e par une configuration hydraulique assez simple √† 2 contr√¥les: un radier naturel fait office de contr√¥le section pour les basses eaux, puis un chenal rectangulaire large contr√¥le les hautes eaux, comme illustr√© ci-dessous.</p>
<br>
<img src="Sauze.jpg" width="70%">
<p style="text-align: center;color: gray;">
Configuration hydraulique pour l‚ÄôArd√®che √† Sauze-Saint-Martin (l‚Äôeau s‚Äô√©coule du haut vers le bas de l‚Äôimage, l‚Äô√©chelle est indiqu√©e en jaune). (a) Propri√©t√©s du chenal contr√¥lant les hautes eaux ; (b) zoom sur la section de contr√¥le des basses eaux.
</p>
<p>Le code ci-dessous sp√©cifie les distributions a priori des 6 param√®tres de la courbe de tarage: hauteur d‚Äôactivation, coefficient et exposant de chacun des deux contr√¥les. Pour plus de d√©tails sur la sp√©cification des a priori √† cette station, vous pouvez consulter l‚Äôarticle de <a href="https://hal.science/hal-00934237">Le Coz et al., 2014</a>.</p>
<pre class="r"><code># Param√®tres du contr√¥le section en basses eaux: hauteur d&#39;activation k, coefficient a et exposant c
k1=parameter(name=&#39;k1&#39;,init=-0.5,prior.dist=&#39;Uniform&#39;,prior.par=c(-1.5,0))
a1=parameter(name=&#39;a1&#39;,init=50,prior.dist=&#39;LogNormal&#39;,prior.par=c(log(50),1))
c1=parameter(name=&#39;c1&#39;,init=1.5,prior.dist=&#39;Gaussian&#39;,prior.par=c(1.5,0.05))
# Param√®tres du contr√¥le chenal en hautes eaux: hauteur d&#39;activation k, coefficient a et exposant c
k2=parameter(name=&#39;k2&#39;,init=1,prior.dist=&#39;Gaussian&#39;,prior.par=c(1,1))
a2=parameter(name=&#39;a2&#39;,init=100,prior.dist=&#39;LogNormal&#39;,prior.par=c(log(100),1))
c2=parameter(name=&#39;c2&#39;,init=1.67,prior.dist=&#39;Gaussian&#39;,prior.par=c(1.67,0.05))</code></pre>
<p>La matrice des contr√¥les est ensuite d√©finie comme suit :</p>
<pre class="r"><code># Matrice des contr√¥les : les colonnes repr√©sentent les contr√¥les, les lignes les segments de hauteur.
# Ici la matrice signifie que le contr√¥le section est l&#39;unique contr√¥le actif en basses eaux,
# puis le contr√¥le chenal est l&#39;unique contr√¥le actif en hautes eaux.
controlMatrix=rbind(c(1,0),
                    c(0,1))</code></pre>
<p>Pour finir, toutes ces informations sont transmises √† <code>RBaM</code> en cr√©ant un objet de type <code>model</code> comme indiqu√© ci-dessous :</p>
<pre class="r"><code># Tout r√©unir dans un objet de type &quot;model&quot;
M=model(ID=&#39;BaRatin&#39;, # ID du mod√®le consid√©r√© - ici, BaRatin
        nX=1,nY=1, # nombre de variables d‚Äôentr√©e/sortie : ici, 1 entr√©e (H) et 1 sortie (Q)
        par=list(k1,a1,c1,k2,a2,c2), # liste des param√®tres du mod√®le - bien respecter l&#39;ordre (k,a,c) pour chaque contr√¥le successif
        xtra=xtraModelInfo(object=controlMatrix)) # faire passer la matrice des contr√¥les via xtraModelInfo() comme indiqu√© ici</code></pre>
<p>Nous avons donc √† pr√©sent d√©fini le mod√®le √† estimer <code>M</code> ainsi que les donn√©es de calage <code>D</code>: tout est par√© pour le calage !</p>
</div>
<div id="lancer-bam-et-explorer-les-simulations-mcmc" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Lancer BaM et explorer les simulations MCMC</h2>
<p>La fonction <code>BaM</code> est utilis√©e pour effectuer l‚Äôestimation des param√®tres. Ceci lancera un <a href="/fr/doc/topics/mcmc">simulateur MCMC</a> et sauvegardera les r√©sultats dans le workspace.</p>
<pre class="r"><code>BaM(mod=M,data=D) # Estimer les param√®tres du mod√®le M en utilisant les donn√©es de calage D</code></pre>
<p>Les √©chantillons MCMC peuvent √† pr√©sent √™tre lus. Il y a 2 fichiers MCMC: ‚ÄòResults_MCMC.txt‚Äô contient les simulations brutes et est donc assez volumineux. ‚ÄòResults_Cooking.txt‚Äô contient les simulations post-trait√©es avec un ‚Äòbr√ªlage‚Äô de la premi√®re partie des it√©rations et un ‚Äòaffinage‚Äô des simulations restantes (voir <a href="/fr/doc/topics/mcmc">cette page</a> pour des explications plus d√©taill√©es). Ce dernier fichier devrait √™tre favoris√© dans la plupart des cas. Les propri√©t√©s des simulations MCMC peuvent √©videmment √™tre modifi√©es si n√©cessaire : pour cela voir les pages d‚Äôaide <code>?BaM</code>, <code>?mcmcOptions</code> et <code>?mcmcCooking</code>.</p>
<pre class="r"><code># Lecture des simulations MCMC post-trait√©es
MCMC=readMCMC(file.path(workspace,&#39;Results_Cooking.txt&#39;))
head(MCMC)</code></pre>
<pre><code>##          k1      a1      c1       k2       a2      c2    Y1_g1     Y1_g2
## 1 -0.246780 60.4238 1.48103 0.922899 102.8730 1.70117 2.582080 0.0224468
## 2 -0.269413 60.5724 1.46413 0.930665  99.0574 1.70117 2.232150 0.0131388
## 3 -0.291071 58.2851 1.51878 1.000870 105.3410 1.71316 1.904870 0.0157354
## 4 -0.327582 55.5986 1.50333 1.053400 108.8020 1.67034 2.385710 0.0118051
## 5 -0.346240 53.3239 1.50333 1.087950 120.9590 1.66413 0.756269 0.0414687
## 6 -0.353747 51.7361 1.49109 1.045050 110.3710 1.69349 0.590987 0.0467566
##    LogPost        b1        b2
## 1 -153.555 -0.246780 0.0845701
## 2 -152.904 -0.269413 0.0544618
## 3 -151.209 -0.291071 0.1125240
## 4 -150.324 -0.327582 0.1588370
## 5 -146.927 -0.346240 0.2412690
## 6 -145.997 -0.353747 0.1859880</code></pre>
<p>Quelques fonctions sont fournies avec <code>RBaM</code> pour explorer les simulations MCMC. La premi√®re fonction trace les valeurs simul√©es pour chaque param√®tre (‚Äútrace plot‚Äù) et est utile pour juger visuellement de la convergence des simulations MCMC.</p>
<pre class="r"><code># Trace plot pour chaque param√®tre, utile pour √©valuer la convergence
plots=tracePlot(MCMC)
patchwork::wrap_plots(plots,ncol=3)</code></pre>
<p><img src="en/fig-unnamed-chunk-11-1.png" width="864" /></p>
<p>La seconde fonction trace la densit√© a posteriori de chaque param√®tre.</p>
<pre class="r"><code># Densit√©  pour chaque param√®tre
plots=densityPlot(MCMC)
patchwork::wrap_plots(plots,ncol=3)</code></pre>
<p><img src="en/fig-unnamed-chunk-12-1.png" width="864" /></p>
<p>La troisi√®me fonction cr√©e un ‚Äú<a href="https://en.wikipedia.org/wiki/Violin_plot">violin plot</a>‚Äù qui est utile pour comparer les distributions a posteriori de plusieurs param√®tres dans un unique graphique (ici par exemple l‚Äôexposant de chaque contr√¥le).</p>
<pre class="r"><code># Violin plot, utile pour des param√®tres &#39;comparables&#39;
violinPlot(MCMC[c(&#39;c1&#39;,&#39;c2&#39;)])</code></pre>
<p><img src="en/fig-unnamed-chunk-13-1.png" width="576" /></p>
</div>
<div id="estimer-la-courbe-de-tarage-et-ses-incertitudes" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Estimer la courbe de tarage et ses incertitudes</h2>
<p>La courbe de tarage et ses incertitudes peuvent √™tre estim√©es √† partir des simulations MCMC. Pour y parvenir, il faut d‚Äôabord d√©finir la grille de valeurs de hauteur sur laquelle la courbe de tarage est calcul√©e. Il faut ensuite d√©finir un objet de type <code>prediction</code> qui sp√©cifie quels types d‚Äôincertitude doivent √™tre propag√©s. Par exemple, l‚Äôincertitude totale r√©clame de propager √† la fois l‚Äôincertitude param√©trique (induite par la connaissance imparfaite des param√®tres de la courbe) et l‚Äô<a href="/fr/doc/baratinage/erreurs-structurelles/">incertitude structurelle</a> (induite par le caract√®re approximatif de toute courbe de tarage).</p>
<pre class="r"><code># D√©finition de la grille de hauteurs sur laquelle la courbe de tarage est calcul√©e
hgrid=data.frame(H=seq(-1,7,0.1))
# D√©finition d&#39;un objet &#39;prediction&#39; pour l&#39;incertitude totale
totalU=prediction(X=hgrid, # hauteurs
                  spagFiles=&#39;hQ_totalU.spag&#39;, # fichier dans lequel les pr√©dictions sont sauvegard√©es
                  data.dir=workspace, # Une copie des jeux de donn√©es sera √©crite dans ce dossier
                  doParametric=TRUE, # propager l&#39;incertitude param√©trique ?
                  doStructural=TRUE) # propager l&#39;incertitude structurelle ?</code></pre>
<p>La propagation d‚Äôincertitude est ensuite effectu√©e en utilisant la m√™me fonction <code>BaM</code> que pr√©c√©demment, mais en mode ‚Äúpr√©diction‚Äù. Pour cela les options <code>doCalib=FALSE</code> et <code>doPred=TRUE</code> indiquent que le calage a d√©j√† √©t√© effectu√©, et que la t√¢che √† accomplir est d‚Äôutiliser les simulations MCMC existantes pour effectuer une pr√©diction incertaine (en l‚Äôoccurrence, estimer la courbe de tarage et ses incertitudes). Notez que le mot ‚Äúpr√©diction‚Äù est utilis√© ici dans un sens tr√®s g√©n√©rique qui signifie ‚Äúestimer les sorties incertaines du mod√®le‚Äù.</p>
<pre class="r"><code># Re-lancer BaM, mais en mode &quot;pr√©diction&quot;
BaM(mod=M,data=D, # mod√®le et donn√©es
    pred=totalU, # pr√©diction √† effectuer
    doCalib=FALSE,doPred=TRUE) # Ne pas re-caler mais faire les pr√©dictions</code></pre>
<p>Le fichier ‚Äòspaghetti‚Äô r√©sultant de l‚Äôappel de cette fonction peut √™tre lu dans le workspace et visualis√© comme indiqu√© ci-dessous. Bien que les spaghetti constituent les sorties brutes des pr√©dictions, il est souvent plus pratique de tracer des intervalles d‚Äôincertitude. Ceux-ci ont √©t√© calcul√©s automatiquement par <code>BaM</code> et sauvegard√©s dans les fichiers portant l‚Äôextension ‚Äò.env‚Äô (comme ‚Äòenveloppe‚Äô).</p>
<pre class="r"><code>par(mfrow=c(1,2)) # 2 figures sur la m√™me ligne
# spaghetti repr√©sentant l&#39;incertitude totale
Q=read.table(file.path(workspace,&#39;hQ_totalU.spag&#39;))
matplot(hgrid$H,Q,col=&#39;red&#39;,type=&#39;l&#39;,lty=1,main=&#39;spaghetti&#39;)
# Intervalles √† 95% pour l&#39;incertitude totale
Q=read.table(file.path(workspace,&#39;hQ_totalU.env&#39;),header=T)
matplot(hgrid$H,Q[,2:3],col=&#39;red&#39;,type=&#39;l&#39;,lty=1,main=&#39;uncertainty envelop&#39;)</code></pre>
<p><img src="en/fig-unnamed-chunk-16-1.png" width="864" /></p>
<p>La m√™me logique peut √™tre utilis√©e pour estimer l‚Äôincertitude param√©trique seule (ce qui revient √† ‚Äúd√©sactiver‚Äù l‚Äôincertitude structurelle) et la courbe de tarage maxpost (ce qui revient √† ‚Äúd√©sactiver‚Äù les incertitudes param√©triques et structurelle).</p>
<pre class="r"><code># D√©finir un objet &#39;prediction&#39; pour l&#39;incertitude param√©trique seule - notez le doStructural=FALSE
paramU=prediction(X=hgrid,spagFiles=&#39;hQ_paramU.spag&#39;,data.dir=workspace,
                  doParametric=TRUE,doStructural=FALSE)
# D√©finir un objet &#39;prediction&#39; sans incertitude, ce qui conduit √† la courbe de tarage maxpost
maxpost=prediction(X=hgrid,spagFiles=&#39;hQ_maxpost.spag&#39;,data.dir=workspace,
                  doParametric=FALSE,doStructural=FALSE)
# Lancer BaM en mode pr√©diction
BaM(mod=M,data=D, # model and data
    pred=list(paramU,maxpost), # pr√©dictions √† effectuer - quand il y en a plusieurs, il faut les rassembler dans une liste
    doCalib=FALSE,doPred=TRUE) # Ne pas re-caler mais faire les pr√©dictions</code></pre>
<p>Il est maintenant possible de recr√©er la figure propos√©e par <code>BaRatinAGE</code>, qui superpose l‚Äôincertitude totale, l‚Äôincertitude param√©trique, la courbe de tarage maxpost et les jaugeages.</p>
<pre class="r"><code># Lire et tracer en rouge l&#39;enveloppe repr√©sentant l&#39;incertitude totale
Q=read.table(file.path(workspace,&#39;hQ_totalU.env&#39;),header=T)
matplot(hgrid$H,Q[,2:3],col=&#39;red&#39;,type=&#39;l&#39;,lty=1)
# Lire et tracer en rose l&#39;enveloppe repr√©sentant l&#39;incertitude param√©trique
Q=read.table(file.path(workspace,&#39;hQ_paramU.env&#39;),header=T)
matplot(hgrid$H,Q[,2:3],col=&#39;pink&#39;,type=&#39;l&#39;,lty=1,add=TRUE)
# Lire et tracer en noir la courbe de tarage maxpost
Q=read.table(file.path(workspace,&#39;hQ_maxpost.spag&#39;))
matplot(hgrid$H,Q,col=&#39;black&#39;,type=&#39;l&#39;,lty=1,add=TRUE)
# Ajouter les jaugeages
points(x=SauzeGaugings$H,y=SauzeGaugings$Q,pch=19)
segments(x0=SauzeGaugings$H,y0=SauzeGaugings$Q-1.96*SauzeGaugings$uQ,y1=SauzeGaugings$Q+1.96*SauzeGaugings$uQ)</code></pre>
<p><img src="en/fig-unnamed-chunk-18-1.png" width="864" /></p>
</div>
<div id="production-dun-hydrogramme-incertain" class="section level2" number="2.5">
<h2><span class="header-section-number">2.5</span> Production d‚Äôun hydrogramme incertain</h2>
<p>La production d‚Äôun hydrogramme incertain est quasiment identique √† celle d‚Äôune courbe de tarage incertaine : la seule chose √† changer est de remplacer la grille de hauteurs par un limnigramme, comme celui repr√©sent√© ci-dessous par exemple (le fichier de donn√©es peut √™tre t√©l√©charg√© <a href="SauzeHt.csv">ici</a>)</p>
<pre class="r"><code># Lecture et trac√© du limnigramme
ht=read.table(&#39;SauzeHt.csv&#39;,header=T,sep=&#39;;&#39;,colClasses=c(&#39;POSIXct&#39;,&#39;numeric&#39;))
plot(ht,type=&#39;l&#39;)</code></pre>
<p><img src="en/fig-unnamed-chunk-19-1.png" width="864" /></p>
<p>Le code est le m√™me que pr√©c√©demment, √† l‚Äôexception du fait que les valeurs de hauteur utilis√©es dans les pr√©dictions proviennent du limnigramme (<code>ht['stage']</code>) plut√¥t que de la grille de hauteur (<code>hgrid</code>).</p>
<pre class="r"><code># Objet &#39;prediction&#39; pour l&#39;incertitude totale
totalU=prediction(X=ht[&#39;stage&#39;],spagFiles=&#39;Qt_totalU.spag&#39;,data.dir=workspace, 
                  doParametric=TRUE,doStructural=TRUE) 
# Objet &#39;prediction&#39; pour l&#39;incertitude param√©trique
paramU=prediction(X=ht[&#39;stage&#39;],spagFiles=&#39;Qt_paramU.spag&#39;,data.dir=workspace,
                  doParametric=TRUE,doStructural=FALSE)
# Objet &#39;prediction&#39; pour l&#39;hydrogramme maxpost
maxpost=prediction(X=ht[&#39;stage&#39;],spagFiles=&#39;Qt_maxpost.spag&#39;,data.dir=workspace,
                  doParametric=FALSE,doStructural=FALSE)
# lancer BaM en mode pr√©diction
BaM(mod=M,data=D,pred=list(totalU,paramU,maxpost),doCalib=FALSE,doPred=TRUE)</code></pre>
<p>L‚Äôhydrogramme r√©sultant de ce calcul peut √™tre trac√© avec ses incertitudes.</p>
<pre class="r"><code># Incertitude totale en rouge
Q=read.table(file.path(workspace,&#39;Qt_totalU.env&#39;),header=T)
matplot(ht$time,Q[,2:3],col=&#39;red&#39;,type=&#39;l&#39;,lty=1)
# Incertitude param√©trique en rose
Q=read.table(file.path(workspace,&#39;Qt_paramU.env&#39;),header=T)
matplot(ht$time,Q[,2:3],col=&#39;pink&#39;,type=&#39;l&#39;,lty=1,lwd=2,add=TRUE)
# Hydrogramme maxpost en noir
Q=read.table(file.path(workspace,&#39;Qt_maxpost.spag&#39;))
matplot(ht$time,Q,col=&#39;black&#39;,type=&#39;l&#39;,lty=1,add=TRUE)</code></pre>
<p><img src="en/fig-unnamed-chunk-21-1.png" width="864" /></p>
<p>Notez qu‚Äôaucune incertitude n‚Äôa √©t√© consid√©r√©e sur le limnigramme. Il est possible de rajouter cette composante en utilisant, plut√¥t qu‚Äôun unique limnigramme, des ‚Äúspaghetti de limnigramme‚Äù, c‚Äôest √† dire de nombreux limnigrammes r√©pliqu√©s qui quantifient l‚Äôincertitude. L‚Äôexemple ci-dessous montre comment g√©n√©rer ces spaghetti dans le cas d‚Äôerreurs Gaussiennes ind√©pendantes d‚Äô√©cart-type constant <span class="math inline">\(\sigma_h=5 \mathrm{cm}\)</span>. Des mod√®les d‚Äôerreurs plus avanc√©s pourraient √™tre utilis√©s (comme d√©crit dans <a href="/fr/doc/topics/limni/">cette page</a>) mais pour le moment <code>RBaM</code> ne propose pas de fonctionnalit√© d√©di√©e - la g√©n√©ration des spaghetti de limnigramme reste donc de votre responsabilit√©.</p>
<pre class="r"><code>set.seed(82487)
# Cr√©er 100 r√©plications pour ht, avec un √©cart-type de 5cm
htrep=matrix(rnorm(n=NROW(ht)*100,mean=ht$stage,sd=0.05),nrow=NROW(ht),ncol=100)
# Tracer les spaghetti de limnigramme 
matplot(ht$time,htrep,col=&#39;gray&#39;,type=&#39;l&#39;,lty=1)</code></pre>
<p><img src="en/fig-unnamed-chunk-22-1.png" width="864" /></p>
<p>Le reste de l‚Äôanalyse se d√©roule comme pr√©c√©demment, en rempla√ßant le limnigramme unique par les spaghetti de limnigramme.</p>
<pre class="r"><code># Incertitude totale
totalU=prediction(X=list(htrep), # spaghetti, doivent obligatoirement √™tre plac√©s dans une liste
                  spagFiles=&#39;Qt_param_struct_hU.spag&#39;, data.dir=workspace,
                  doParametric=TRUE, doStructural=TRUE)
# Incertitudes param+hauteur (incertitude structurelle d√©sactiv√©e)
param_hU=prediction(X=list(htrep),spagFiles=&#39;Qt_param_hU.spag&#39;,data.dir=workspace,
                  doParametric=TRUE,doStructural=FALSE)
# Incertitude de hauteur seulement  (incertitudes structurelle et param√©trique d√©sactiv√©es)
hU=prediction(X=list(htrep),spagFiles=&#39;Qt_hU.spag&#39;,data.dir=workspace,
                  doParametric=FALSE,doStructural=FALSE)
# lancer BaM en mode pr√©diction
BaM(mod=M,data=D,pred=list(totalU,param_hU,hU),doCalib=FALSE,doPred=TRUE)</code></pre>
<p>Ceci conduit √† la figure ci-dessous. Notez qu‚Äôun axe des ordonn√©es logarithmique a √©t√© utilise pour mettre en avant les moyennes et basses eaux pour lesquelles l‚Äôincertitude due aux hauteurs est notable.</p>
<pre class="r"><code># Incertitude totale en rouge
Q=read.table(file.path(workspace,&#39;Qt_param_struct_hU.env&#39;),header=T)
matplot(ht$time,Q[,2:3],col=&#39;red&#39;,type=&#39;l&#39;,lty=1,log=&#39;y&#39;)
# Incertitude param√©trique+hauteur en rose
Q=read.table(file.path(workspace,&#39;Qt_param_hU.env&#39;),header=T)
matplot(ht$time,Q[,2:3],col=&#39;pink&#39;,type=&#39;l&#39;,lty=1,lwd=2,add=TRUE)
# Incertitude hauteur en jaune
Q=read.table(file.path(workspace,&#39;Qt_hU.env&#39;),header=T)
matplot(ht$time,Q[,2:3],col=&#39;goldenrod1&#39;,type=&#39;l&#39;,lty=1,lwd=2,add=TRUE)
# Hydrogramme maxpost en noir
Q=read.table(file.path(workspace,&#39;Qt_maxpost.spag&#39;))
matplot(ht$time,Q,col=&#39;black&#39;,type=&#39;l&#39;,lty=1,add=TRUE)</code></pre>
<p><img src="en/fig-unnamed-chunk-24-1.png" width="864" /></p>
</div>
</div>
<div id="conclusion" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Conclusion</h1>
<p>Le package <code>RBaM</code> permet de piloter BaRatin directement depuis <code>R</code> sans passer par l‚Äôinterface graphique <code>BaRatinAGE</code>. Bien que cela demande un apprentissage plus long, le jeu peut en valoir la chandelle, surtout pour les utilisateurs qui sont d√©j√† familiers avec le language <code>R</code>:</p>
<ul>
<li><code>RBaM</code> offre plus de flexibilit√© dans l‚Äôapplication de BaRatin</li>
<li><code>RBaM</code> facilite l‚Äôint√©gration d‚Äôanalyses BaRatin dans d‚Äôautres processus d‚Äôanalyse existants</li>
<li><code>RBaM</code> permet d‚Äôacc√©der √† tous les outils de l‚Äô√©cosyst√®me <code>R</code>, en particulier pour pr√©parer les donn√©es, visualiser les r√©sultats, effectuer des analyses statistiques, etc.</li>
<li>Enfin, et c‚Äôest important, <code>RBaM</code> ne se restreint pas au mod√®le de courbe de tarage de BaRatin. En particulier, des mod√®les de courbes de tarage non-univoques (par exemple dans le cas de remous variable, d‚Äôinfluence de la v√©g√©tation, de d√©tarages multiples etc.) sont disponibles dans <code>RBaM</code> mais pas encore dans <code>BaRatinAGE</code>. De mani√®re g√©n√©rale, tout nouveau mod√®le sera disponible dans <code>RBaM</code> bien avant qu‚Äôil le soit dans <code>BaRatinAGE</code>.</li>
</ul>
</div>


                        </div>                        
                        
  <div class="container">
    
    

    
		
		    <a href="https://baratin-tools.github.io/fr/doc/case/ardeche-meyras/">L&#39;Ard√®che √† Meyras</a> 
		

		
		    &nbsp; | &nbsp;
		
    
		
		    <a href="https://baratin-tools.github.io/fr/doc/case/isere-grenoble/">L&#39;Is√®re √† Grenoble-Campus</a> 
		

		
		    &nbsp; | &nbsp;
		
    
		
		    <a href="https://baratin-tools.github.io/fr/doc/case/mercier-d610/">Le Mercier au pont de la D610</a> 
		

		
		    &nbsp; | &nbsp;
		
    
		
		    <a href="https://baratin-tools.github.io/fr/doc/case/charbonnieres/">Le ruisseau de Charbonni√®res</a> 
		

		
		    &nbsp; | &nbsp;
		
    
		
		   <strong> <a href="https://baratin-tools.github.io/fr/doc/case/rbam/">Utilisation de RBaM</a> </strong> 

		

		
		    &nbsp; | &nbsp;
		
    
         
  
  </div>
    




                    </div>
                    

                    

                    

                    <div class="col-md-2">

                        
                        
                        
  <div class="container">
  	<h3> Sections </h3>
    
    
    
		
		    <a href="https://baratin-tools.github.io/fr/doc/case/ardeche-meyras/">L&#39;Ard√®che √† Meyras : <br> une configuration classique √† 3 contr√¥les</a> </br> </br>
		
    
		
		    <a href="https://baratin-tools.github.io/fr/doc/case/isere-grenoble/">L&#39;Is√®re √† Grenoble-Campus : <br> un unique cont√¥le chenal</a> </br> </br>
		
    
		
		    <a href="https://baratin-tools.github.io/fr/doc/case/mercier-d610/">Le Mercier au pont de la D610 : <br> une combinaison de d√©versoirs artificiels</a> </br> </br>
		
    
		
		    <a href="https://baratin-tools.github.io/fr/doc/case/charbonnieres/">Le ruisseau de Charbonni√®res : <br> d√©versoir &#34;triangle tronqu√©&#34;</a> </br> </br>
		
    
		
		<div style="background-color:beige;">
		   <strong> <a href="https://baratin-tools.github.io/fr/doc/case/rbam/">Utilisation de RBaM : <br> contr√¥ler BaRatin depuis R !</a> </strong></br>
		</div>
		</br>
		
    
         
  
  </div>
    





                        

                    </div>
                    

                    

                </div>
                

            </div>
            
            
            
        </div>
        

        <footer id="footer">
  <div class="container">
    
  
    <div class="col-xs-3">
    	<p> <strong> BaRatin</strong> - Bayesian Rating Curves </p>
        <p> <strong>Contact</strong>: baratin.dev %at% inrae.fr </p>
    </div>
  
    <div class="col-xs-3">
        <p> <a href="https://github.com/BaRatin-tools"> <img alt="GitHub logo" src="/img/github-mark.svg" width="24" height="24" /> https://github.com/BaRatin-tools </a> </p>
        <p> <a href="https://github.com/BaM-tools"> <img alt="GitHub logo" src="/img/github-mark.svg" width="24" height="24" /> https://github.com/BaM-tools </a> </p>
    </div>
  
    <div class="col-xs-3">
      <p> 
       <a href="https://www.inrae.fr"><img style="max-width:90%;max-height:40px;" src="/img/Logo-INRAE_Transparent.png" alt="INRAE"> </a>
      </p>   
    </div>
    
    <div class="col-xs-3">
      <p> 
       <a href="https://gdh-hydrometrie.org/"><img style="max-width:90%;max-height:76px;" src="/img/Logo-GDH.png" alt="GDH"> </a>
      </p>   
    </div>
      
  </div>
    
</footer>




    </div>
    

    
<script src="//code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js"></script>


<script src="/js/front.js"></script>



  </body>
</html>
